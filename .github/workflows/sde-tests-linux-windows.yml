name: Run Linux and Windows (x86, x64) Tests with Intel SDE Processors

env:
  SDE_WINDOWS_URL: https://downloadmirror.intel.com/843185/sde-external-9.48.0-2024-11-25-win.tar.xz
  SDE_LINUX_URL: https://downloadmirror.intel.com/843185/sde-external-9.48.0-2024-11-25-lin.tar.xz

on:
  workflow_dispatch:

jobs:

  build:
    uses: ./.github/workflows/build-linux-windows.yml

  run-sde-tests:
    strategy:
      matrix:
        arch: [windows-x86, windows-x64, linux-x86_64]
        sde-cpu: [wsm, snb, ivb, hsw, adl, gnr256, skx, clx, icl, spr]
    runs-on: ${{ matrix.arch == 'linux-x86_64' && 'ubuntu-latest' || 'windows-latest' }}
    needs: build
    continue-on-error: true

    name: >
      (${{ matrix.arch }}, ${{ matrix.sde-cpu }})
      - ${{ fromJson('{
        "wsm": {"main": "Westmere Processor             - Supports SSE41"},
        "snb": {"main": "Sandy Bridge CPU               - Supports SSE41, AVX"},
        "ivb": {"main": "Ivy Bridge CPU                 - Supports SSE41, AVX, F16C"},
        "hsw": {"main": "Haswell CPU                    - Supports SSE41, AVX, F16C, FMA3, AVX2"},
        "adl": {"main": "Alder Lake CPU                 - Supports SSE41, AVX, F16C, FMA3, AVX2, AVXVNNI, AVXVNNIINT8"},
        "gnr256": {"main": "Granite Rapids AVX 10.1 CPU - Supports SSE41, AVX, F16C, FMA3, AVX2, AVXVNNI, AVXVNNIINT8, AVX256SKX, AVX256VNNI, AVX256VNNIGFNI},
        "skx": {"main": "Skylake Server CPU             - Supports SSE41, AVX, F16C, FMA3, AVX2, AVX512F, AVX512SKX, AVX256SKX"},
        "clx": {"main": "Cascade Lake CPU               - Supports SSE41, AVX, F16C, FMA3, AVX2, AVX512F, AVX512SKX, AVX256SKX, AVX512VNNI, AVX256VNNI"},
        "cpx": {"main": "Cooper Lake Processor          - Supports SSE41, AVX, F16C, FMA3, AVX2, AVX512F, AVX512SKX, AVX256SKX, AVX512VNNI, AVX256VNNI, AVX512BF16"},
        "icl": {"main": "Ice Lake CPU                   - Supports SSE41, AVX, F16C, FMA3, AVX2, AVX512F, AVX512SKX, AVX256SKX, AVX512VNNI, AVX256VNNI, AVX512VBMI, AVX512VNNIGFNI AVX256VNNIGFNI"},
        "spr": {"main": "Sapphire Rapids CPU            - Supports SSE41, AVX, F16C, FMA3, AVX2, AVX512F, AVX512SKX, AVX256SKX, AVX512VNNI, AVX256VNNI, AVX512VBMI, AVX512VNNIGFNI AVX256VNNIGFNI, AVX512FP16, AVXVNNI, AVXVNNIINT8"}
         }')[matrix.sde-cpu].main }}

    steps:

      - name: Set Build Path
        run: |
          case "${{ matrix.arch }}" in
            "linux-x86_64") BUILD_PATH="build/local" ;;
            "windows-x86") BUILD_PATH="build/windows/x86" ;;
            "windows-x64") BUILD_PATH="build/windows/x64" ;;
          esac
          echo "BUILD_PATH=$BUILD_PATH" >> $GITHUB_ENV
        shell: bash

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ matrix.arch }}
          path: ${{ env.BUILD_PATH }}

      - name: Download and Extract Intel SDE
        run: |
          if [ "${{ matrix.arch }}" == "linux-x86_64" ]; then
            echo "Downloading Linux Intel SDE"
            wget "$SDE_LINUX_URL" || { echo "Download failed"; exit 1; }
            tar -xf "$(basename "$SDE_LINUX_URL")" || { echo "Extraction failed"; exit 1; }
          elif [[ "${{ matrix.arch }}" == "windows-x86" || "${{ matrix.arch }}" == "windows-x64" ]]; then
            echo "Downloading Windows Intel SDE"
            curl -LO "$SDE_WINDOWS_URL" || { echo "Download failed"; exit 1; }
            tar -xf "$(basename "$SDE_WINDOWS_URL")" || { echo "Extraction failed"; exit 1; }
          fi
        shell: bash

      - name: Set SDE PATH
        run: |
          if [ "${{ matrix.arch }}" == "linux-x86_64" ]; then
            SDE_DIR="$(basename "$SDE_LINUX_URL" | sed 's/.tar.xz//')"
          elif [[ "${{ matrix.arch }}" == "windows-x86" || "${{ matrix.arch }}" == "windows-x64" ]]; then
            SDE_DIR="$(basename "$SDE_WINDOWS_URL" | sed 's/.tar.xz//')"
          fi
          SDE_PATH="${{ github.workspace }}/${SDE_DIR}/sde"
          echo "SDE_PATH=$SDE_PATH" >> $GITHUB_ENV
        shell: bash

      - name: Run SDE tests (Linux-x86_64)
        if: matrix.arch == 'linux-x86_64'
        run: |
          chmod +x ./*
          "${{ env.SDE_PATH }}" -${{ matrix.sde-processor }} -chip_check_exe_only -- ctest -C Release --output-on-failure --parallel $(nproc)
        working-directory: ${{ env.BUILD_PATH }}
        shell: bash

      - name: Run SDE tests (Windows-x86 and Windows-x64)
        if: matrix.arch == 'windows-x86' || matrix.arch == 'windows-x64'
        run: |
          & "$env:SDE_PATH" -${{ matrix.sde-processor }} -chip_check_exe_only -- ctest -C Release --output-on-failure --parallel $env:NUMBER_OF_PROCESSORS
        working-directory: ${{ env.BUILD_PATH }}
        shell: pwsh