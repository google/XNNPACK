name: Build and Run Tests

on:
  workflow_call:
    inputs:
      run-tests:
        description: 'Whether to also run unit tests, where possible.'
        default: true
        required: false
        type: boolean
      update-caches:
        description: 'Whether to update the `ccache` or `bazel` caches, where possible.'
        default: false
        required: false
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}-${{ inputs.update-caches }}
  cancel-in-progress: true

jobs:
  cmake-linux-x86_64:
    runs-on: 'ubuntu-24.04-8core'
    timeout-minutes: 60
    container:
      image: ghcr.io/google/xnnpack/standard:latest
    env:
      CMAKE_C_COMPILER_LAUNCHER: ccache
      CMAKE_CXX_COMPILER_LAUNCHER: ccache
      CCACHE_DIR: /home/xnnpack/.ccache
    steps:
      - uses: actions/checkout@v6

      - name: Mount ccache
        uses: actions/cache@v5
        with:
          path: /home/xnnpack/.ccache
          key: ccache-${{ runner.os }}-${{ github.job }}-${{ github.run_id }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ github.job }}-
      - name: Configure ccache limit
        run: |
          ccache -M 500M
          ccache -z
      - name: Configure and build
        run: scripts/build-local.sh
      - name: Run tests
        if: ${{ inputs.run-tests }}
        run: ctest --output-on-failure --parallel $(nproc)
        working-directory: build/local
      - name: Print ccache stats
        run: ccache -s

  cmake-linux-aarch64:
    runs-on: 'arm-ubuntu-arm-22.04-8core'
    timeout-minutes: 60
    container:
      image: ghcr.io/google/xnnpack/standard:latest
    env:
      CMAKE_C_COMPILER_LAUNCHER: ccache
      CMAKE_CXX_COMPILER_LAUNCHER: ccache
      CCACHE_DIR: /home/xnnpack/.ccache
    steps:
      - uses: actions/checkout@v6

      - name: Mount ccache
        uses: actions/cache@v5
        with:
          path: /home/xnnpack/.ccache
          key: ccache-${{ runner.os }}-${{ github.job }}-${{ github.run_id }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ github.job }}-
      - name: Configure ccache limit
        run: |
          ccache -M 500M
          ccache -z
      - name: Configure and build
        run: scripts/build-local.sh
      - name: Run tests
        if: ${{ inputs.run-tests }}
        run: ctest --output-on-failure --parallel $(nproc)
        working-directory: build/local
      - name: Print ccache stats
        run: ccache -s

  cmake-linux-armhf:
    runs-on: arm-ubuntu-arm-22.04-8core
    timeout-minutes: 60
    container:
      image: ghcr.io/google/xnnpack/standard:latest
    env:
      CMAKE_C_COMPILER_LAUNCHER: ccache
      CMAKE_CXX_COMPILER_LAUNCHER: ccache
      CCACHE_DIR: /home/xnnpack/.ccache
    steps:
      - uses: actions/checkout@v6

      - name: Mount ccache
        uses: actions/cache@v5
        with:
          path: /home/xnnpack/.ccache
          key: ccache-armhf-${{ runner.os }}-${{ github.job }}-${{ github.run_id }}
          restore-keys: |
            ccache-armhf-${{ runner.os }}-${{ github.job }}-

      - name: Configure ccache limit
        run: |
          ccache -M 500M
          ccache -z

      - name: Configure and build
        run: scripts/build-linux-armhf.sh -DCMAKE_BUILD_TYPE=Release

      - name: Run tests
        if: ${{ inputs.run-tests }}
        run: ctest --output-on-failure --parallel $(nproc)
        working-directory: build/linux/armhf

      - name: Print ccache stats
        run: ccache -s

  cmake-linux-riscv64:
    runs-on: 'ubuntu-24.04-16core'
    timeout-minutes: 60
    container:
      image: ghcr.io/google/xnnpack/riscv:latest
    env:
      CMAKE_C_COMPILER_LAUNCHER: ccache
      CMAKE_CXX_COMPILER_LAUNCHER: ccache
      CCACHE_DIR: /home/xnnpack/.ccache
    steps:
      - uses: actions/checkout@v6

      - name: Mount ccache
        uses: actions/cache@v5
        with:
          path: /home/xnnpack/.ccache
          key: ccache-riscv64-${{ runner.os }}-${{ github.job }}-${{ github.run_id }}
          restore-keys: |
            ccache-riscv64-${{ runner.os }}-${{ github.job }}-

      - name: Configure ccache limit
        run: |
          ccache -M 500M
          ccache -z

      - name: Configure and build
        run: scripts/build-linux-riscv64.sh -DCMAKE_BUILD_TYPE=Release -DXNNPACK_ENABLE_RISCV_VECTOR=OFF

      - name: Run tests
        if: ${{ inputs.run-tests }}
        run: ctest --output-on-failure --parallel $(nproc)
        working-directory: build/linux/riscv64

      - name: Print ccache stats
        run: ccache -s

  cmake-linux-riscv64-rvv:
    runs-on: 'ubuntu-24.04-16core'
    timeout-minutes: 60
    container:
      image: ghcr.io/google/xnnpack/riscv:latest
    env:
      CMAKE_C_COMPILER_LAUNCHER: ccache
      CMAKE_CXX_COMPILER_LAUNCHER: ccache
      CCACHE_DIR: /home/xnnpack/.ccache
    steps:
      - uses: actions/checkout@v6

      - name: Mount ccache
        uses: actions/cache@v5
        with:
          path: /home/xnnpack/.ccache
          key: ccache-riscv64-rvv-${{ runner.os }}-${{ github.job }}-${{ github.run_id }}
          restore-keys: |
            ccache-riscv64-rvv-${{ runner.os }}-${{ github.job }}-

      - name: Configure ccache limit
        run: |
          ccache -M 500M
          ccache -z

      - name: Configure and build
        run: |
          scripts/build-linux-riscv64.sh \
            -DCMAKE_BUILD_TYPE=Release \
            -DXNNPACK_ENABLE_RISCV_VECTOR=ON \
            -DUSE_GNU_SOURCE=ON \
            -DRISCV_TOOLCHAIN_ROOT=/opt/riscv \
            -DRISCV_QEMU_ROOT=/opt/qemu

      - name: Run tests (no operator tests)
        if: ${{ inputs.run-tests }}
        run: ctest --output-on-failure --label-exclude operator --parallel $(nproc)
        working-directory: build/linux/riscv64

      - name: Print ccache stats
        run: ccache -s

  cmake-windows-arm64:
    runs-on: windows-2022-32core
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v6
      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ github.job }}
          max-size: "500M"
          save: ${{ inputs.update-caches }}
      - name: Install Ninja
        uses: seanmiddleditch/gha-setup-ninja@master
      - name: Setup build environment
        shell: bash
        run: |
          echo "VCVARSALL=$(vswhere -products \* -latest -property installationPath)\\VC\\Auxiliary\\Build\\vcvarsall.bat" >> $GITHUB_ENV
      - name: Configure and build
        run: scripts/build-windows-arm64.cmd
        shell: cmd
        working-directory: ${{ github.workspace }}
        env:
          CFLAGS: "/UNDEBUG"
          CXXFLAGS: "/UNDEBUG"

  cmake-windows-x64:
    runs-on: windows-2022-32core
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v6
      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ github.job }}
          max-size: "500M"
          save: ${{ inputs.update-caches }}
      - name: Install Ninja
        uses: seanmiddleditch/gha-setup-ninja@master
      - name: Setup build environment
        shell: bash
        run: |
          echo "VCVARSALL=$(vswhere -products \* -latest -property installationPath)\\VC\\Auxiliary\\Build\\vcvarsall.bat" >> $GITHUB_ENV
      - name: Configure and build
        run: scripts/build-windows-x64.cmd
        shell: cmd
        working-directory: ${{ github.workspace }}
        env:
          CFLAGS: "/UNDEBUG"
          CXXFLAGS: "/UNDEBUG"
      - name: Run tests
        if: ${{ inputs.run-tests }}
        run: ctest -C Release --output-on-failure --parallel $NUMBER_OF_PROCESSORS
        working-directory: ${{ github.workspace }}/build/windows/x64

  cmake-windows-x86:
    runs-on: windows-2022-32core
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v6
      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ github.job }}
          max-size: "500M"
          save: ${{ inputs.update-caches }}
      - name: Install Ninja
        uses: seanmiddleditch/gha-setup-ninja@master
      - name: Setup build environment
        shell: bash
        run: |
          echo "VCVARSALL=$(vswhere -products \* -latest -property installationPath)\\VC\\Auxiliary\\Build\\vcvarsall.bat" >> $GITHUB_ENV
      - name: Configure and build
        run: scripts/build-windows-x86.cmd
        shell: cmd
        working-directory: ${{ github.workspace }}
        env:
          CFLAGS: "/UNDEBUG"
          CXXFLAGS: "/UNDEBUG"
      - name: Run tests
        if: ${{ inputs.run-tests }}
        run: ctest -C Release --output-on-failure --parallel $NUMBER_OF_PROCESSORS
        working-directory: ${{ github.workspace }}/build/windows/x86

  cmake-macos-arm64:
    runs-on: macos-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v6
      - name: Install ninja
        run: brew install ninja
      - name: Create output directory
        run: mkdir -p build/macos/arm64
        working-directory: ${{ github.workspace }}
      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ github.job }}
          max-size: "500M"
          save: ${{ inputs.update-caches }}
      - name: Generate CMake project
        run: |
          cmake \
            -G Ninja \
            -DCMAKE_CONFIGURATION_TYPES=Release \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DHAVE_STD_REGEX=TRUE \
            ../../..
        working-directory: ${{ github.workspace }}/build/macos/arm64
      - name: Build with Xcode
        run: |
          cmake \
            --build \
            build/macos/arm64 \
            -j$((2*$(sysctl -n hw.ncpu)))
        working-directory: ${{ github.workspace }}

  cmake-android:
    strategy:
      matrix:
        arch: [arm64, armv7, x86]
    runs-on: 'ubuntu-24.04-8core'
    timeout-minutes: 60
    container:
      image: ghcr.io/google/xnnpack/android:latest
    env:
      CMAKE_C_COMPILER_LAUNCHER: ccache
      CMAKE_CXX_COMPILER_LAUNCHER: ccache
      CCACHE_DIR: /home/xnnpack/.ccache
    steps:
      - uses: actions/checkout@v6

      - name: Mount ccache
        uses: actions/cache@v5
        with:
          path: /home/xnnpack/.ccache
          key: ccache-android-${{ matrix.arch }}-${{ github.sha }}
          restore-keys: |
            ccache-android-${{ matrix.arch }}-

      - name: Configure ccache limit
        run: |
          ccache -M 500M
          ccache -z

      - name: Configure and build
        run: scripts/build-android-${{ matrix.arch }}.sh

      - name: Print ccache stats
        run: ccache -s

  cmake-ios-arm64:
    runs-on: macos-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v6
      - name: Create output directory
        run: mkdir -p build/ios/arm64
        working-directory: ${{ github.workspace }}
      - name: Generate CMake project
        run: cmake -G Xcode -DCMAKE_SYSTEM_NAME=iOS -DCMAKE_OSX_ARCHITECTURES=arm64 -DXNNPACK_BUILD_BENCHMARKS=OFF -DXNNPACK_BUILD_TESTS=OFF ../../..
        working-directory: ${{ github.workspace }}/build/ios/arm64
      - name: Build with Xcode
        run: cmake --build build/ios/arm64 --parallel $(sysctl -n hw.ncpu) -- -quiet
        working-directory: ${{ github.workspace }}

  cmake-ios-x86_64:
    runs-on: macos-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v6
      - name: Create output directory
        run: mkdir -p build/ios/x86_64
        working-directory: ${{ github.workspace }}
      - name: Generate CMake project
        run: cmake -G Xcode -DCMAKE_SYSTEM_NAME=iOS -DCMAKE_OSX_ARCHITECTURES=x86_64 -DXNNPACK_BUILD_BENCHMARKS=OFF -DXNNPACK_BUILD_TESTS=OFF ../../..
        working-directory: ${{ github.workspace }}/build/ios/x86_64
      - name: Build with Xcode
        run: cmake --build build/ios/x86_64 --parallel $(sysctl -n hw.ncpu) -- -sdk iphonesimulator -quiet
        working-directory: ${{ github.workspace }}

  bazel-linux-x86_64-clang-18:
    runs-on: 'ubuntu-24.04-8core'
    timeout-minutes: 60
    container:
      image: ghcr.io/google/xnnpack/standard:latest
    env:
      CC: clang-18
      CXX: clang++-18
    steps:
      - uses: actions/checkout@v6
      - name: Mount Bazel Cache
        uses: actions/cache@v5
        with:
          path: |
            /home/xnnpack/.cache/bazel/disk_cache
            /home/xnnpack/.cache/bazel/repo_cache
          key: bazel-clang18-opt-${{ runner.os }}-${{ github.job }}-${{ github.run_id }}
          restore-keys: |
            bazel-clang18-opt-${{ runner.os }}-${{ github.job }}-

      - name: Build tests
        if: ${{ !inputs.run-tests }}
        run: |
            bazel build \
              -c opt \
              --disk_cache=/home/xnnpack/.cache/bazel/disk_cache \
              --repository_cache=/home/xnnpack/.cache/bazel/repo_cache \
              --test_output=errors \
              //test/... \
              //bench/...

      - name: Build and run tests
        if: ${{ inputs.run-tests }}
        run: |
            bazel test \
              -c opt \
              --disk_cache=/home/xnnpack/.cache/bazel/disk_cache \
              --repository_cache=/home/xnnpack/.cache/bazel/repo_cache \
              --test_output=errors \
              --local_test_jobs=HOST_CPUS \
              //test/... \
              //bench/... \
              //ynnpack/...

      - name: Compress disk cache
        if: ${{ inputs.update-caches }}
        run: |
          mkdir -p /home/xnnpack/.cache/bazel/disk_cache
          find /home/xnnpack/.cache/bazel/disk_cache -type f -atime +7 -delete

  bazel-linux-x86_64-gcc-9:
    runs-on: 'ubuntu-24.04-8core'
    timeout-minutes: 60
    container:
      image: ghcr.io/google/xnnpack/standard:latest
    env:
      CC: gcc-9
      CXX: g++-9
      BAZEL_DEFINES: |
        --define=xnn_enable_avxvnni=false
        --define=xnn_enable_avx256vnni=false
        --define=xnn_enable_avxvnniint8=false
        --define=xnn_enable_avx512amx=false
        --define=xnn_enable_avx512fp16=false
        --define=xnn_enable_avx512bf16=false
        --define=ynn_enable_x86_amx=false
        --define=ynn_enable_x86_avx512fp16=false
        --define=ynn_enable_x86_avx512bf16=false
    steps:
      - uses: actions/checkout@v6
      - name: Mount Bazel Cache
        uses: actions/cache@v5
        with:
          path: |
            /home/xnnpack/.cache/bazel/disk_cache
            /home/xnnpack/.cache/bazel/repo_cache
          key: bazel-gcc9-opt-${{ runner.os }}-${{ github.job }}-${{ github.run_id }}
          restore-keys: |
            bazel-gcc9-opt-${{ runner.os }}-${{ github.job }}-

      - name: Build tests
        if: ${{ !inputs.run-tests }}
        run: |
            bazel build \
              -c opt \
              --disk_cache=/home/xnnpack/.cache/bazel/disk_cache \
              --repository_cache=/home/xnnpack/.cache/bazel/repo_cache \
              ${BAZEL_DEFINES} \
              //test/... \
              //bench/...

      - name: Build and run tests
        if: ${{ inputs.run-tests }}
        run: |
            bazel test \
              -c opt \
              --disk_cache=/home/xnnpack/.cache/bazel/disk_cache \
              --repository_cache=/home/xnnpack/.cache/bazel/repo_cache \
              --test_output=errors \
              --local_test_jobs=HOST_CPUS \
              ${BAZEL_DEFINES} \
              //test/... \
              //bench/... \
              //ynnpack/...

      - name: Compress disk cache
        if: ${{ inputs.update-caches }}
        run: |
          mkdir -p /home/xnnpack/.cache/bazel/disk_cache
          find /home/xnnpack/.cache/bazel/disk_cache -type f -atime +7 -delete

  bazel-linux-aarch64-clang18:
    runs-on: 'arm-ubuntu-arm-22.04-8core'
    timeout-minutes: 60
    container:
      image: ghcr.io/google/xnnpack/standard:latest
    env:
      CC: clang-18
      CXX: clang++-18
    steps:
      - uses: actions/checkout@v6
      - name: Mount Bazel Cache
        uses: actions/cache@v5
        with:
          path: |
            /home/xnnpack/.cache/bazel/disk_cache
            /home/xnnpack/.cache/bazel/repo_cache
          key: bazel-clang18-opt-${{ runner.os }}-${{ github.job }}-${{ github.run_id }}
          restore-keys: |
            bazel-clang18-opt-${{ runner.os }}-${{ github.job }}-

      - name: Build tests
        if: ${{ !inputs.run-tests }}
        run: |
            bazel build \
              -c opt \
              --disk_cache=/home/xnnpack/.cache/bazel/disk_cache \
              --repository_cache=/home/xnnpack/.cache/bazel/repo_cache \
              --test_output=errors \
              //test/... \
              //bench/...

      - name: Build and run tests
        if: ${{ inputs.run-tests }}
        run: |
            bazel test \
              -c opt \
              --disk_cache=/home/xnnpack/.cache/bazel/disk_cache \
              --repository_cache=/home/xnnpack/.cache/bazel/repo_cache \
              --test_output=errors \
              --local_test_jobs=HOST_CPUS \
              //test/... \
              //bench/... \
              //ynnpack/...

      - name: Compress disk cache
        if: ${{ inputs.update-caches }}
        run: |
          mkdir -p /home/xnnpack/.cache/bazel/disk_cache
          find /home/xnnpack/.cache/bazel/disk_cache -type f -atime +7 -delete

  bazel-linux-aarch64-gcc13:
    # This ensures we have solid test coverage for _Float16
    runs-on: 'arm-ubuntu-arm-22.04-8core'
    timeout-minutes: 60
    container:
      image: ghcr.io/google/xnnpack/standard:latest
    env:
      CC: gcc-13
      CXX: g++-13
      BAZEL_DEFINES: |
        --define=ynn_enable_arm64_sme=false
        --define=ynn_enable_arm_neonbf16=false
    steps:
      - uses: actions/checkout@v6
      - name: Mount Bazel Cache
        uses: actions/cache@v5
        with:
          path: |
            /home/xnnpack/.cache/bazel/disk_cache
            /home/xnnpack/.cache/bazel/repo_cache
          key: bazel-gcc13-opt-${{ runner.os }}-${{ github.job }}-${{ github.run_id }}
          restore-keys: |
            bazel-gcc13-opt-${{ runner.os }}-${{ github.job }}-

      - name: Build tests
        if: ${{ !inputs.run-tests }}
        run: |
            bazel build \
              -c opt \
              --disk_cache=/home/xnnpack/.cache/bazel/disk_cache \
              --repository_cache=/home/xnnpack/.cache/bazel/repo_cache \
              ${BAZEL_DEFINES} \
              //test/... \
              //bench/...

      - name: Build and run tests
        if: ${{ inputs.run-tests }}
        run: |
            bazel test \
              -c opt \
              --disk_cache=/home/xnnpack/.cache/bazel/disk_cache \
              --repository_cache=/home/xnnpack/.cache/bazel/repo_cache \
              --test_output=errors \
              --local_test_jobs=HOST_CPUS \
              ${BAZEL_DEFINES} \
              //test/... \
              //bench/... \
              //ynnpack/...

      - name: Compress disk cache
        if: ${{ inputs.update-caches }}
        run: |
          mkdir -p /home/xnnpack/.cache/bazel/disk_cache
          find /home/xnnpack/.cache/bazel/disk_cache -type f -atime +7 -delete

  bazel-linux-aarch64-sme2-qemu:
    runs-on: "arm-ubuntu-arm-22.04-8core"
    timeout-minutes: 60
    env:
      QEMU_ARGS: -cpu max
    steps:
      - uses: actions/checkout@v6
      - name: Update apt
        run: |
          echo 'set man-db/auto-update false' | sudo debconf-communicate >/dev/null
          sudo dpkg-reconfigure man-db
          sudo apt update
      - name: Install clang-20
        working-directory: ${{ github.workspace }}
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 20
          clang-20 --version
      - name: Restore bazel cache
        uses: actions/cache/restore@v4
        with:
          path: "/home/runner/.cache/bazel"
          key: ${{ github.job }}
          restore-keys: |
            ${{ github.job }}-
      - name: Check for cached qemu build
        id: cached-qemu-restore
        uses: actions/cache/restore@v4
        with:
          path: |
            ${{ github.workspace }}/bin/qemu-aarch64
            ${{ github.workspace }}/qemu-master.tar.bz2.sha256
          key: ${{ runner.os }}-qemu-aarch64
      - name: Download and build qemu-aarch64 (if newer)
        id: build-qemu
        env:
          CC: clang-20
          CXX: clang++-20
        run: |
          mkdir -p bin
          wget -Snv https://gitlab.com/qemu-project/qemu/-/archive/master/qemu-master.tar.bz2
          if [ ! -f qemu-master.tar.bz2.sha256 ] || [[ $(sha256sum -c qemu-master.tar.bz2.sha256) && $? -eq 1 ]]; then
            echo " "
            echo "Rebuilding qemu-aarch64 from latest commit!"
            echo " "
            echo "save=true" >> "$GITHUB_OUTPUT"
            sha256sum qemu-master.tar.bz2 > qemu-master.tar.bz2.sha256
            sudo apt-get install libglib2.0-dev libfdt-dev libpixman-1-dev zlib1g-dev ninja-build
            tar xjf qemu-master.tar.bz2
            cd $(ls -dt qemu-* | tail -1)
            ./configure --target-list=aarch64-linux-user
            make -j $(nproc)
            cp -f build/qemu-aarch64 ../bin/
          fi
        working-directory: ${{ github.workspace }}
      - name: Save cached qemu build
        id: cached-qemu-save
        if: ${{ steps.build-qemu.outputs.save }}
        uses: actions/cache/save@v4
        with:
          path: |
            ${{ github.workspace }}/bin/qemu-aarch64
            ${{ github.workspace }}/qemu-master.tar.bz2.sha256
          key: ${{ runner.os }}-qemu-aarch64
      - name: Build microkernel and subgraph tests
        if: ${{ !inputs.run-tests }}
        env:
          CC: clang-20
          CXX: clang++-20
          USE_BAZEL_VERSION: 8.5.1
        run: |
          bazel build \
            -c opt \
            --copt=-g1 \
            --copt=-DGOOGLE_COMMANDLINEFLAGS_FULL_API=1 \
            --platforms=//build_config:aarch64_linux \
            --run_under="${PWD}/bin/qemu-aarch64 ${QEMU_ARGS} " \
            --define xnn_enable_arm_sme2=true \
            --dynamic_mode=off \
            --features=fully_static_link \
            //test:qs8_qc8w_igemm_minmax_fp32_test \
            //test:qp8_f32_qc4w_gemm_minmax_test \
            //test:pf32_gemm_minmax_test \
            //test:pf16_gemm_minmax_test \
            //test:pqs8_qc8w_gemm_minmax_test \
            //test/subgraph/... \
            //ynnpack/...
        working-directory: ${{ github.workspace }}
      - name: Build and run microkernel tests
        if: ${{ inputs.run-tests }}
        env:
          CC: clang-20
          CXX: clang++-20
          USE_BAZEL_VERSION: 8.5.1
        run: |
          bazel test \
            -c opt \
            --copt=-g1 \
            --copt=-DGOOGLE_COMMANDLINEFLAGS_FULL_API=1 \
            --platforms=//build_config:aarch64_linux \
            --run_under="${PWD}/bin/qemu-aarch64 ${QEMU_ARGS} " \
            --define xnn_enable_arm_sme2=true \
            --dynamic_mode=off \
            --features=fully_static_link \
            //test:qs8_qc8w_igemm_minmax_fp32_test \
            //test:qp8_f32_qc4w_gemm_minmax_test \
            //test:pf32_gemm_minmax_test \
            //test:pf16_gemm_minmax_test \
            //test:pqs8_qc8w_gemm_minmax_test \
            --cache_test_results=no \
            --test_filter="*NEONSME2*" \
            --test_output=errors \
            --test_timeout=600 \
            --local_test_jobs=$(nproc)
        working-directory: ${{ github.workspace }}
      - name: Build and run subgraph tests
        if: ${{ inputs.run-tests }}
        env:
          CC: clang-20
          CXX: clang++-20
          USE_BAZEL_VERSION: 8.5.1
        run: |
          bazel test \
            -c opt \
            --copt=-g1 \
            --copt=-DGOOGLE_COMMANDLINEFLAGS_FULL_API=1 \
            --platforms=//build_config:aarch64_linux \
            --run_under="${PWD}/bin/qemu-aarch64 ${QEMU_ARGS} " \
            --define xnn_enable_arm_sme2=true \
            --dynamic_mode=off \
            --features=fully_static_link \
            //test/subgraph/... \
            //ynnpack/... \
            --cache_test_results=no \
            --test_output=errors \
            --test_timeout=600 \
            --local_test_jobs=$(nproc)
        working-directory: ${{ github.workspace }}
      - name: Upload binary artifacts
        uses: actions/upload-artifact@v6
        with:
          name: binaries
          path: |
            ${{ github.workspace }}/bin/qemu-aarch64
            ${{ github.workspace }}/bazel-bin/test/**/*_test
            !${{ github.workspace }}/bazel-bin/test/**/*.runfiles
            !${{ github.workspace }}/bazel-bin/test/**/_objs
          overwrite: true
      - name: Upload log artifacts
        uses: actions/upload-artifact@v6
        with:
          name: test_logs
          path:  ~/.cache/bazel/**/test.log
          include-hidden-files: true
          overwrite: true
      - name: Compress disk cache
        # Bazel's `--disk-cache` currently grows without bounds, so we remove files
        # that haven't been accessed in 7+ days manually.
        if: ${{ inputs.update-caches }}
        run: find $HOME/.cache/bazel -type f -atime +7 -delete
      - name: Save bazel cache
        if: ${{ inputs.update-caches }}
        uses: actions/cache/save@v4
        with:
          path: "/home/runner/.cache/bazel"
          key: ${{ github.job }}-${{ github.sha }}

